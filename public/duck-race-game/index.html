<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Duck Race - Pure HTML</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            overflow: hidden;
        }
        .hidden { display: none; }
        /* NEW: Styles for the fact modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fact-modal {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-900">
    <main class="relative w-screen h-screen flex items-center justify-center bg-cover bg-center" style="background-image: url('../assets/duck-background.jpg')">
        <div class="absolute inset-0 bg-blue-900 bg-opacity-40 backdrop-blur-sm"></div>

        <!-- Start Screen -->
        <div id="start-screen" class="relative z-10 text-center">
            <h1 class="text-6xl font-bold text-yellow-300 mb-4" data-t="title">Duck Race</h1>
            <p class="text-xl text-cyan-200 mb-8" data-t="subtitle">First duck to cross the finish line wins!</p>
            <!-- NEW: Educational Button and Language Switcher Added -->
            <div class="flex flex-col items-center gap-4">
                <button id="start-button" class="px-8 py-4 bg-yellow-400 text-gray-900 font-bold rounded-lg shadow-lg hover:bg-yellow-500 transition-transform transform hover:scale-105" data-t="startButton">
                    Start Race
                </button>
                <button id="learn-button" class="px-6 py-3 bg-cyan-600 text-white font-bold rounded-lg shadow-lg hover:bg-cyan-700 transition-transform transform hover:scale-105" data-t="learnButton">
                    Learn about river ecosystems
                </button>
                <div id="lang-switcher" class="mt-4 p-2 bg-black bg-opacity-50 rounded-lg flex gap-2">
                    <button class="lang-btn px-4 py-1 text-white rounded active" data-lang="en">EN</button>
                    <button class="lang-btn px-4 py-1 text-white rounded" data-lang="pl">PL</button>
                    <button class="lang-btn px-4 py-1 text-white rounded" data-lang="de">DE</button>
                    <button class="lang-btn px-4 py-1 text-white rounded" data-lang="cs">CS</button>
                </div>
            </div>
        </div>

        <!-- Level Complete Screen -->
        <div id="level-complete-screen" class="relative z-10 text-center bg-black bg-opacity-70 p-10 rounded-xl hidden">
            <h2 id="level-complete-title" class="text-5xl font-bold text-yellow-300 mb-4"></h2>
            <p id="level-complete-stats" class="text-xl text-cyan-200 mb-6"></p>
            <p id="level-complete-desc" class="text-2xl text-white mb-6"></p>
            <button id="next-level-button" class="px-8 py-4 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition-transform transform hover:scale-105"></button>
        </div>
        
        <!-- Final Win Screen -->
        <div id="final-win-screen" class="relative z-10 text-center bg-black bg-opacity-70 p-10 rounded-xl hidden">
            <h2 class="text-5xl font-bold text-yellow-300 mb-4" data-t="finalWinTitle">Race Completed!</h2>
            <p class="text-2xl text-white mb-2" data-t="finalWinCongrats">Congratulations, you beat all 5 levels!</p>
            <p class="text-xl text-cyan-200 mb-8" data-t="finalWinTimeLabel">Your final time:</p>
            <p id="final-time-display" class="text-4xl font-mono text-yellow-300 mb-8"></p>
            <button id="close-and-save-button" class="px-8 py-4 bg-blue-500 text-white font-bold rounded-lg shadow-lg hover:bg-blue-600 transition-transform transform hover:scale-105" data-t="finalWinButton">
                Save score and return to app
            </button>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="relative z-10 text-center bg-black bg-opacity-70 p-10 rounded-xl hidden">
            <h2 class="text-5xl font-bold text-yellow-300 mb-4" data-t="gameOverTitle">Race Over!</h2>
            <p id="game-over-text" class="text-3xl text-white mb-6"></p>
            <p id="game-over-stats" class="text-xl text-cyan-200 mb-6"></p>
            <button id="restart-button" class="px-8 py-4 bg-yellow-400 text-gray-900 font-bold rounded-lg shadow-lg hover:bg-yellow-500 transition-transform transform hover:scale-105" data-t="restartButton">
                Race Again
            </button>
        </div>

        <!-- Game Canvas Area -->
        <div id="game-canvas-container" class="relative z-10 flex flex-col items-center hidden">
            <div id="game-ui" class="text-white bg-black bg-opacity-50 px-4 py-2 rounded-t-lg flex justify-between items-center w-full">
                <div>
                    <h2 id="level-display" class="text-xl font-bold text-yellow-300"></h2>
                    <p class="text-sm text-cyan-100" data-t="gameHint">Click water to splash, click garbage for +10 points!</p>
                </div>
                 <div class="text-center mx-4">
                    <p class="text-lg font-bold" data-t="scoreLabel">Score: <span id="score-display" class="font-mono">0</span></p>
                    <p class="text-lg font-bold" data-t="timeLabel">Time: <span id="time-display" class="font-mono">00:00</span></p>
                </div>
                <!-- NEW: Splash strength is now fixed, so the slider is removed. Added some padding for alignment. -->
                <div class="w-48"></div>
            </div>
            <canvas id="game-canvas" class="bg-blue-800 bg-opacity-80 border-4 border-yellow-400 rounded-b-lg shadow-2xl"></canvas>
        </div>

        <!-- NEW: Learn Modal -->
        <div id="learn-modal" class="absolute inset-0 z-20 bg-black bg-opacity-75 flex items-center justify-center hidden">
            <div class="bg-gray-800 text-white p-8 rounded-lg max-w-2xl text-center shadow-2xl">
                <h2 class="text-3xl font-bold text-cyan-300 mb-4" data-t="learnModalTitle">River Ecosystems</h2>
                <p class="text-lg mb-6" data-t="learnModalText">Rivers are vital lifelines. They create unique habitats for fish, insects, and microorganisms, forming a complex food web. Fish help control insect populations, while microorganisms break down waste, naturally cleaning the water. Rivers also act as corridors, allowing animals to move, breed, and find new territories.</p>
                <button id="close-learn-modal" class="px-6 py-3 bg-cyan-600 text-white font-bold rounded-lg shadow-lg hover:bg-cyan-700" data-t="closeButton">Close</button>
            </div>
        </div>
        
        <!-- NEW: Fact Modal -->
        <div id="fact-modal" class="absolute top-5 right-5 z-20 bg-gray-800 text-white p-6 rounded-lg max-w-sm shadow-2xl fact-modal hidden">
            <h3 class="text-xl font-bold text-yellow-300 mb-3" data-t="factTitle">Did you know?</h3>
            <p id="fact-text" class="text-md mb-4"></p>
            <button id="close-fact-modal" class="w-full px-4 py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600" data-t="closeButton">Close</button>
        </div>

    </main>

    <script type="module">
        // --- Types (Enums) ---
        const GameState = { StartScreen: 0, Playing: 1, GameOver: 2, LevelComplete: 3, FinalWin: 4 };
        const PlayerType = { Human: 0, Bot: 1 };
        const ObstacleType = { Log: 0, Garbage: 1 };

        // NEW: Translations object
        const translations = {
            en: {
                title: "Duck Race", subtitle: "First duck to cross the finish line wins!", startButton: "Start Race",
                learnButton: "Learn about river ecosystems", restartButton: "Race Again",
                finalWinTitle: "Race Completed!", finalWinCongrats: "Congratulations, you beat all 5 levels!",
                finalWinTimeLabel: "Your final time:", finalWinButton: "Save score and return to app",
                gameOverTitle: "Race Over!", gameHint: "Click water to splash, click garbage for +10 points!",
                scoreLabel: "Score:", timeLabel: "Time:", learnModalTitle: "River Ecosystems",
                learnModalText: "Rivers are vital lifelines. They create unique habitats for fish, insects, and microorganisms, forming a complex food web. Fish help control insect populations, while microorganisms break down waste, naturally cleaning the water. Rivers also act as corridors, allowing animals to move, breed, and find new territories.",
                closeButton: "Close", factTitle: "Did you know?",
                levelComplete: (level) => `Level ${level} Complete!`,
                nextLevelDesc: { 2: "Next: Polluted Pass. Garbage will send you back to the start!", 3: "Next: Tricky Turn. A mix of logs and garbage awaits.", 4: "Next: The Rapids! The current is much faster here!", 5: "Next: The Foggy Finish! Navigate through thick fog to win!" },
                nextLevelButton: (level) => `Start Level ${level}`,
                gameOverLost: "You lost the race!", gameOverWon: (level) => `You won Level ${level}!`,
                gameOverChampion: "üéâ You beat all the levels! You're the champion! üéâ",
                gameOverBotWon: (name) => `${name} won the race!`
            },
            pl: {
                title: "Wy≈õcig Kaczek", subtitle: "Pierwsza kaczka na mecie wygrywa!", startButton: "Rozpocznij Wy≈õcig",
                learnButton: "Dowiedz siƒô o ekosystemach rzecznych", restartButton: "Jeszcze Raz",
                finalWinTitle: "Wy≈õcig Uko≈Ñczony!", finalWinCongrats: "Gratulacje, uko≈Ñczy≈Çe≈õ wszystkie 5 poziom√≥w!",
                finalWinTimeLabel: "Tw√≥j ko≈Ñcowy czas:", finalWinButton: "Zapisz wynik i wr√≥ƒá do aplikacji",
                gameOverTitle: "Koniec Wy≈õcigu!", gameHint: "Kliknij wodƒô by chlapaƒá, kliknij ≈õmieci by dostaƒá +10 punkt√≥w!",
                scoreLabel: "Punkty:", timeLabel: "Czas:", learnModalTitle: "Ekosystemy Rzeczne",
                learnModalText: "Rzeki to kluczowe arterie ≈ºycia. TworzƒÖ unikalne siedliska dla ryb, owad√≥w i mikroorganizm√≥w, tworzƒÖc z≈Ço≈ºonƒÖ sieƒá pokarmowƒÖ. Ryby pomagajƒÖ kontrolowaƒá populacje owad√≥w, a mikroorganizmy rozk≈ÇadajƒÖ odpady, naturalnie oczyszczajƒÖc wodƒô. Rzeki dzia≈ÇajƒÖ r√≥wnie≈º jak korytarze, umo≈ºliwiajƒÖc zwierzƒôtom przemieszczanie siƒô, rozmna≈ºanie i znajdowanie nowych terytori√≥w.",
                closeButton: "Zamknij", factTitle: "Czy wiesz, ≈ºe?",
                levelComplete: (level) => `Poziom ${level} Uko≈Ñczony!`,
                nextLevelDesc: { 2: "Nastƒôpny: Zanieczyszczona Prze≈Çƒôcz. ≈ömieci cofnƒÖ ciƒô na start!", 3: "Nastƒôpny: Podstƒôpny Zakrƒôt. Czeka na ciebie mieszanka k≈Ç√≥d i ≈õmieci.", 4: "Nastƒôpny: Bystrza! PrƒÖd jest tu znacznie szybszy!", 5: "Nastƒôpny: Mglisty Finisz! Przebij siƒô przez gƒôstƒÖ mg≈Çƒô, aby wygraƒá!" },
                nextLevelButton: (level) => `Rozpocznij Poziom ${level}`,
                gameOverLost: "Przegra≈Çe≈õ wy≈õcig!", gameOverWon: (level) => `Wygra≈Çe≈õ Poziom ${level}!`,
                gameOverChampion: "üéâ Uko≈Ñczy≈Çe≈õ wszystkie poziomy! Jeste≈õ mistrzem! üéâ",
                gameOverBotWon: (name) => `${name} wygra≈Ç wy≈õcig!`
            },
            de: {
                title: "Entenrennen", subtitle: "Die erste Ente im Ziel gewinnt!", startButton: "Rennen starten",
                learnButton: "√úber Fluss√∂kosysteme lernen", restartButton: "Nochmal fahren",
                finalWinTitle: "Rennen beendet!", finalWinCongrats: "Herzlichen Gl√ºckwunsch, du hast alle 5 Level geschafft!",
                finalWinTimeLabel: "Deine Endzeit:", finalWinButton: "Ergebnis speichern und zur App zur√ºckkehren",
                gameOverTitle: "Rennen vorbei!", gameHint: "Klicke auf Wasser, um zu spritzen, klicke auf M√ºll f√ºr +10 Punkte!",
                scoreLabel: "Punkte:", timeLabel: "Zeit:", learnModalTitle: "Fluss√∂kosysteme",
                learnModalText: "Fl√ºsse sind lebenswichtige Lebensadern. Sie schaffen einzigartige Lebensr√§ume f√ºr Fische, Insekten und Mikroorganismen und bilden ein komplexes Nahrungsnetz. Fische helfen, Insektenpopulationen zu kontrollieren, w√§hrend Mikroorganismen Abf√§lle abbauen und das Wasser nat√ºrlich reinigen. Fl√ºsse fungieren auch als Korridore, die es Tieren erm√∂glichen, sich zu bewegen, zu vermehren und neue Reviere zu finden.",
                closeButton: "Schlie√üen", factTitle: "Wusstest du schon?",
                levelComplete: (level) => `Level ${level} abgeschlossen!`,
                nextLevelDesc: { 2: "N√§chstes: Verschmutzter Pass. M√ºll schickt dich zur√ºck an den Start!", 3: "N√§chstes: Knifflige Kurve. Eine Mischung aus Baumst√§mmen und M√ºll erwartet dich.", 4: "N√§chstes: Die Stromschnellen! Die Str√∂mung ist hier viel schneller!", 5: "N√§chstes: Das neblige Finale! Navigiere durch dichten Nebel, um zu gewinnen!" },
                nextLevelButton: (level) => `Level ${level} starten`,
                gameOverLost: "Du hast das Rennen verloren!", gameOverWon: (level) => `Du hast Level ${level} gewonnen!`,
                gameOverChampion: "üéâ Du hast alle Level geschafft! Du bist der Champion! üéâ",
                gameOverBotWon: (name) => `${name} hat das Rennen gewonnen!`
            },
            cs: {
                title: "Z√°vod Kaƒçenek", subtitle: "Prvn√≠ kaƒçenka v c√≠li vyhr√°v√°!", startButton: "Spustit Z√°vod",
                learnButton: "O ≈ô√≠ƒçn√≠ch ekosyst√©mech", restartButton: "Znovu z√°vodit",
                finalWinTitle: "Z√°vod dokonƒçen!", finalWinCongrats: "Gratulujeme, dokonƒçil jsi v≈°ech 5 √∫rovn√≠!",
                finalWinTimeLabel: "Tv≈Øj koneƒçn√Ω ƒças:", finalWinButton: "Ulo≈æit sk√≥re a vr√°tit se do aplikace",
                gameOverTitle: "Konec Z√°vodu!", gameHint: "Klikni na vodu pro ≈°plouchnut√≠, klikni na odpadky pro +10 bod≈Ø!",
                scoreLabel: "Sk√≥re:", timeLabel: "ƒåas:", learnModalTitle: "≈ò√≠ƒçn√≠ ekosyst√©my",
                learnModalText: "≈òeky jsou ≈æivotnƒõ d≈Øle≈æit√© tepny. Vytv√°≈ôej√≠ jedineƒçn√° stanovi≈°tƒõ pro ryby, hmyz a mikroorganismy a tvo≈ô√≠ slo≈æitou potravn√≠ s√≠≈•. Ryby pom√°haj√≠ regulovat populace hmyzu, zat√≠mco mikroorganismy rozkl√°daj√≠ odpad a p≈ôirozenƒõ ƒçist√≠ vodu. ≈òeky tak√© funguj√≠ jako koridory, kter√© zv√≠≈ôat≈Øm umo≈æ≈àuj√≠ pohyb, rozmno≈æov√°n√≠ a hled√°n√≠ nov√Ωch teritori√≠.",
                closeButton: "Zav≈ô√≠t", factTitle: "Vƒõdƒõl jsi?",
                levelComplete: (level) => `√örove≈à ${level} dokonƒçena!`,
                nextLevelDesc: { 2: "Dal≈°√≠: Zneƒçi≈°tƒõn√Ω pr≈Øsmyk. Odpadky tƒõ po≈°lou zpƒõt na start!", 3: "Dal≈°√≠: Z√°ludn√° zat√°ƒçka. ƒåek√° na tebe smƒõs kl√°d a odpadk≈Ø.", 4: "Dal≈°√≠: Pe≈ôeje! Proud je zde mnohem rychlej≈°√≠!", 5: "Dal≈°√≠: Mlhav√Ω fini≈°! Projdi hustou mlhou a vyhraj!" },
                nextLevelButton: (level) => `Spustit √∫rove≈à ${level}`,
                gameOverLost: "Prohr√°l jsi z√°vod!", gameOverWon: (level) => `Vyhr√°l jsi √∫rove≈à ${level}!`,
                gameOverChampion: "üéâ Dokonƒçil jsi v≈°echny √∫rovnƒõ! Jsi ≈°ampion! üéâ",
                gameOverBotWon: (name) => `${name} vyhr√°l z√°vod!`
            }
        };

        // NEW: Array of facts
        const facts = {
            en: [
                "The length of the Mandau river is about 41km.",
                "Mandau flows through both the Czech Republic (Bohemia) and Germany (Saxony) before joining the Lusatian Neisse close to Poland. So the water travels through 3 different countries!",
                "Fish help control insect populations and recycle nutrients in rivers.",
                "Microorganisms break down waste and dead plants, keeping rivers clean.",
                "Rivers connect different habitats, allowing animals to move, breed, and migrate.",
                "There are around 245 fish species present in Germany."
            ],
            pl: [
                "D≈Çugo≈õƒá rzeki Mandau wynosi oko≈Ço 41 km.",
                "Mandau p≈Çynie przez Czechy (Bohemia) i Niemcy (Saksonia), zanim wp≈Çynie do Nysy ≈Åu≈ºyckiej blisko Polski. Woda podr√≥≈ºuje wiƒôc przez 3 r√≥≈ºne kraje!",
                "Ryby pomagajƒÖ kontrolowaƒá populacje owad√≥w i przetwarzajƒÖ sk≈Çadniki od≈ºywcze w rzekach.",
                "Mikroorganizmy rozk≈ÇadajƒÖ odpady i martwe ro≈õliny, utrzymujƒÖc czysto≈õƒá rzek.",
                "Rzeki ≈ÇƒÖczƒÖ r√≥≈ºne siedliska, umo≈ºliwiajƒÖc zwierzƒôtom przemieszczanie siƒô, rozmna≈ºanie i migracjƒô.",
                "W Niemczech wystƒôpuje oko≈Ço 245 gatunk√≥w ryb."
            ],
            de: [
                "Die L√§nge der Mandau betr√§gt etwa 41 km.",
                "Die Mandau flie√üt durch Tschechien (B√∂hmen) und Deutschland (Sachsen), bevor sie nahe Polen in die Lausitzer Nei√üe m√ºndet. Das Wasser reist also durch 3 verschiedene L√§nder!",
                "Fische helfen, Insektenpopulationen zu kontrollieren und N√§hrstoffe in Fl√ºssen zu recyceln.",
                "Mikroorganismen zersetzen Abf√§lle und tote Pflanzen und halten so die Fl√ºsse sauber.",
                "Fl√ºsse verbinden verschiedene Lebensr√§ume und erm√∂glichen es Tieren, sich zu bewegen, zu vermehren und zu wandern.",
                "In Deutschland gibt es etwa 245 Fischarten."
            ],
            cs: [
                "D√©lka ≈ôeky Mandavy je p≈ôibli≈ænƒõ 41 km.",
                "Mandava prot√©k√° jak ƒåeskou republikou (ƒåechy), tak Nƒõmeckem (Sasko), ne≈æ se pobl√≠≈æ Polska vlije do Lu≈æick√© Nisy. Voda tedy putuje p≈ôes 3 r≈Øzn√© zemƒõ!",
                "Ryby pom√°haj√≠ regulovat populace hmyzu a recyklovat ≈æiviny v ≈ôek√°ch.",
                "Mikroorganismy rozkl√°daj√≠ odpad a mrtv√© rostliny a udr≈æuj√≠ tak ≈ôeky ƒçist√©.",
                "≈òeky propojuj√≠ r≈Øzn√° stanovi≈°tƒõ a umo≈æ≈àuj√≠ zv√≠≈ôat≈Øm pohyb, rozmno≈æov√°n√≠ a migraci.",
                "V Nƒõmecku se vyskytuje p≈ôibli≈ænƒõ 245 druh≈Ø ryb."
            ]
        };

        // --- Level Configurations ---
        const LEVEL_CONFIGS = [
            { level: 1, flow: 0.5, spawnRate: 500, maxObs: 15, types: [ObstacleType.Log], hasFog: false, name: "The Calm River" },
            { level: 2, flow: 0.5, spawnRate: 450, maxObs: 20, types: [ObstacleType.Garbage], hasFog: false, name: "Polluted Pass" },
            { level: 3, flow: 0.6, spawnRate: 400, maxObs: 25, types: [ObstacleType.Log, ObstacleType.Garbage], hasFog: false, name: "Tricky Turn" },
            { level: 4, flow: 1.0, spawnRate: 300, maxObs: 30, types: [ObstacleType.Log, ObstacleType.Garbage], hasFog: false, name: "The Rapids" },
            { level: 5, flow: 0.9, spawnRate: 320, maxObs: 35, types: [ObstacleType.Log, ObstacleType.Garbage], hasFog: true, name: "The Foggy Finish" }
        ];
        const MAX_LEVEL = LEVEL_CONFIGS.length;

        // --- Constants ---
        const SIM_HEIGHT = 1.1; const CANVAS_HEIGHT = 300; const CANVAS_WIDTH = 1200;
        const C_SCALE = CANVAS_HEIGHT / SIM_HEIGHT; const SIM_WIDTH = CANVAS_WIDTH / C_SCALE;
        const RESOLUTION = 30; const DT = 1.0 / 60.0; const NUM_ITERS = 20;
        const OVER_RELAXATION = 1.9; const NUM_PLAYERS = 3; const DUCK_SIZE = 12;
        const FINISH_LINE_X = 0.95; const SPLASH_EFFECT_RADIUS = 0.5;
        const STUN_DURATION = 1.5; const FLUID_FORCE_FACTOR = 0.1; const DAMPING_FACTOR = 0.80;
        const SPLASH_RADIUS_RATE = 60; const SPLASH_OPACITY_RATE = 1.2; const OBSTACLE_FLUID_FORCE_FACTOR = DT;
        const RIVERBANK_MARGIN = 0.05 * SIM_HEIGHT; const FOG_START_X = 0.6; const SCORE_PER_GARBAGE = 10;
        
        // NEW: Fixed splash strength and removed bot splash cooldowns for more dynamic gameplay
        const SPLASH_STRENGTH = 2.5; 
        const BOT_SPLASH_STRENGTH = 1.5;

        // --- AI Constants ---
        const BOT_AVOID_DISTANCE = 0.3; const BOT_OFFENSIVE_RANGE = 0.4; const BOT_OFFENSIVE_CHANCE = 0.3;

        // --- Fluid Simulator Class ---
        // ... (FluidSimulator class remains unchanged)
        
        // --- Main App ---
        document.addEventListener('DOMContentLoaded', () => {
            let currentLang = 'en'; // NEW: language state
            let availableFacts = []; // NEW: for fact repetition logic

            // ... (rest of the variable declarations: currentGameState, winner, etc.)

            // NEW: Fact modal elements
            const factModal = document.getElementById('fact-modal');
            const factText = document.getElementById('fact-text');
            const closeFactModal = document.getElementById('close-fact-modal');

            // NEW: Language and translation functions
            function t(key, ...args) {
                const langDict = translations[currentLang] || translations.en;
                const value = key.split('.').reduce((obj, k) => (obj && obj[k] !== 'undefined') ? obj[k] : undefined, langDict);
                if (typeof value === 'function') return value(...args);
                return value || key;
            }

            function updateAllTexts() {
                document.querySelectorAll('[data-t]').forEach(el => {
                    el.textContent = t(el.dataset.t);
                });
            }

            // ... (rest of the DOM element declarations)

            // --- Game Logic ---

            function formatTime(ms) {
                const totalSeconds = ms / 1000;
                const seconds = Math.floor(totalSeconds);
                const milliseconds = Math.floor(ms % 1000).toString().padStart(3, '0');
                return `${seconds}:${milliseconds}`;
            }
            
            // ... (createSplash, spawnObstacle functions)
            // NEW: Updated createSplash to be more responsive
            function createSplash(simX, simY, strength) {
                splashes.push({ x: simX, y: simY, radius: 10, opacity: 1 });
                ducks.forEach(duck => {
                    if (duck.stunned > 0) return;
                    const dx = duck.x - simX;
                    const dy = duck.y - simY;
                    const dist = Math.hypot(dx, dy);
                    if (dist > 0.01 && dist < SPLASH_EFFECT_RADIUS) {
                        const falloff = 1 - (dist / SPLASH_EFFECT_RADIUS);
                        duck.vx += (dx / dist) * strength * falloff;
                        duck.vy += (dy / dist) * strength * falloff;
                    }
                });
                // NEW: Immediately apply a small part of the simulation step for responsiveness
                fluid.simulate(DT / 2, NUM_ITERS / 2, OVER_RELAXATION, config.flow, performance.now() / 1000);
            }
            
            function initializeGame() {
                // ...
                // NEW: Updated bot names
                const playerNames = ['You', 'Duck Alice', 'Duck Bob'];
                // ...
            }
            
            // ... (draw function)

            // ... (update function)
            
            function handleGameEnd(winnerName) {
                // ... (no changes needed here, logic is sound)
            }
            
            // NEW: Function to show a random fact
            function showRandomFact() {
                if (availableFacts.length === 0) {
                    availableFacts = [...facts[currentLang]]; // Reset the list
                }
                const factIndex = Math.floor(Math.random() * availableFacts.length);
                factText.textContent = availableFacts[factIndex];
                availableFacts.splice(factIndex, 1); // Remove fact to prevent repetition
                factModal.classList.remove('hidden');
            }
            
            function startGame() { 
                level = 1; 
                totalTimeMs = 0;
                availableFacts = [...facts[currentLang]]; // NEW: Initialize available facts
                startGameFlow(); 
            };
            const restartGame = () => {
                showRandomFact(); // NEW: Show fact on restart
                startGame();
            };

            // --- Event Listeners ---
            // ... (start, nextLevel, and canvas click listeners)

            // NEW: Language switcher logic
            document.querySelectorAll('.lang-btn').forEach(button => {
                button.addEventListener('click', () => {
                    currentLang = button.dataset.lang;
                    document.querySelector('.lang-btn.active').classList.remove('active');
                    button.classList.add('active');
                    updateAllTexts();
                    availableFacts = [...facts[currentLang]]; // Reset facts for new language
                });
            });

            // NEW: Learn modal listeners
            document.getElementById('learn-button').addEventListener('click', () => {
                document.getElementById('learn-modal').classList.remove('hidden');
            });
            document.getElementById('close-learn-modal').addEventListener('click', () => {
                document.getElementById('learn-modal').classList.add('hidden');
            });
            
            // NEW: Fact modal listener
            closeFactModal.addEventListener('click', () => {
                factModal.classList.add('hidden');
            });
            
            // Initial Call
            updateAllTexts();
            updateUI();
        });
    </script>
</body>
</html>
