<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Duck Race - Pure HTML</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            background-color: #111827;
        }
        .hidden { display: none; }
        
        /* NEW: Styles inspired by Reynolds Experiment */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); }
            100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
        }
        .welcome-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid #374151;
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
        }
        .btn { transition: all 0.2s ease; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { animation: pulse 2s infinite; }
        .btn-primary:hover { transform: translateY(-3px) scale(1.05); }
        .btn-secondary:hover { background-color: #374151; border-color: #facc15; }
        .lang-btn.active { background-color: #facc15; color: #111827; border-color: #fde047; }
        .fact-modal { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="text-white">
    <main class="relative w-screen h-screen flex items-center justify-center bg-cover bg-center" style="background-image: url('../assets/duck-background.jpg')">
        <div id="main-overlay" class="absolute inset-0 bg-blue-900 bg-opacity-40 backdrop-blur-sm"></div>

        <!-- NEW: Redesigned Start Screen -->
        <div id="start-screen" class="relative z-10 text-center p-4">
             <div class="welcome-panel p-8 md:p-12 rounded-xl shadow-2xl max-w-xl w-full">
                <h1 class="text-4xl md:text-5xl font-bold text-yellow-300 mb-2" data-t="title">Duck Race</h1>
                <p class="text-lg text-cyan-200 mb-8" data-t="subtitle">First duck to cross the finish line wins!</p>
                <div class="flex flex-col items-center gap-4">
                    <button id="start-button" class="btn btn-primary w-full md:w-auto px-8 py-3 bg-yellow-400 text-gray-900 font-bold rounded-lg shadow-lg" data-t="startButton">
                        Start Race
                    </button>
                    <button id="learn-button" class="btn btn-secondary w-full md:w-auto px-6 py-3 bg-gray-700/50 border border-gray-600 text-yellow-300 font-bold rounded-lg" data-t="learnButton">
                        Learn about river ecosystems
                    </button>
                    <div id="lang-switcher" class="mt-4 p-2 bg-black bg-opacity-50 rounded-lg flex gap-2">
                        <button class="lang-btn px-4 py-1 rounded" data-lang="en">EN</button>
                        <button class="lang-btn px-4 py-1 rounded" data-lang="pl">PL</button>
                        <button class="lang-btn px-4 py-1 rounded" data-lang="de">DE</button>
                        <button class="lang-btn px-4 py-1 rounded" data-lang="cs">CS</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Level Complete Screen -->
        <div id="level-complete-screen" class="relative z-10 text-center bg-black bg-opacity-70 p-10 rounded-xl hidden">
            <h2 id="level-complete-title" class="text-5xl font-bold text-yellow-300 mb-4"></h2>
            <p id="level-complete-stats" class="text-xl text-cyan-200 mb-6"></p>
            <p id="level-complete-desc" class="text-2xl text-white mb-6"></p>
            <button id="next-level-button" class="px-8 py-4 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600"></button>
        </div>
        
        <!-- Final Win Screen -->
        <div id="final-win-screen" class="relative z-10 text-center bg-black bg-opacity-70 p-10 rounded-xl hidden">
            <h2 class="text-5xl font-bold text-yellow-300 mb-4" data-t="finalWinTitle">Race Completed!</h2>
            <p class="text-2xl text-white mb-2" data-t="finalWinCongrats">Congratulations, you beat all 5 levels!</p>
            <p class="text-xl text-cyan-200 mb-8" data-t="finalWinTimeLabel">Your final time:</p>
            <p id="final-time-display" class="text-4xl font-mono text-yellow-300 mb-8"></p>
            <button id="close-and-save-button" class="px-8 py-4 bg-blue-500 text-white font-bold rounded-lg shadow-lg hover:bg-blue-600" data-t="finalWinButton">
                Save score and return to app
            </button>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="relative z-10 text-center bg-black bg-opacity-70 p-10 rounded-xl hidden">
            <h2 class="text-5xl font-bold text-yellow-300 mb-4" data-t="gameOverTitle">Race Over!</h2>
            <p id="game-over-text" class="text-3xl text-white mb-6"></p>
            <p id="game-over-stats" class="text-xl text-cyan-200 mb-6"></p>
            <button id="restart-button" class="px-8 py-4 bg-yellow-400 text-gray-900 font-bold rounded-lg shadow-lg hover:bg-yellow-500" data-t="restartButton">
                Race Again
            </button>
        </div>

        <!-- Game Canvas Area -->
        <div id="game-canvas-container" class="relative z-10 flex flex-col items-center hidden">
            <div id="game-ui" class="text-white bg-black bg-opacity-50 px-4 py-2 rounded-t-lg flex justify-between items-center w-full">
                <div>
                    <h2 id="level-display" class="text-xl font-bold text-yellow-300"></h2>
                    <p class="text-sm text-cyan-100" data-t="gameHint">Click water to splash, click garbage for +10 points!</p>
                </div>
                 <div class="text-center mx-4">
                    <p class="text-lg font-bold" data-t="scoreLabel">Score: <span id="score-display" class="font-mono">0</span></p>
                    <p class="text-lg font-bold" data-t="timeLabel">Time: <span id="time-display" class="font-mono">00:00</span></p>
                </div>
                <div class="w-48"></div>
            </div>
            <canvas id="game-canvas" class="bg-blue-800 bg-opacity-80 border-4 border-yellow-400 rounded-b-lg shadow-2xl"></canvas>
        </div>

        <!-- Learn Modal -->
        <div id="learn-modal" class="absolute inset-0 z-20 bg-black bg-opacity-75 flex items-center justify-center hidden p-4">
            <div class="bg-gray-800 text-white p-8 rounded-lg max-w-2xl text-center shadow-2xl">
                <h2 class="text-3xl font-bold text-cyan-300 mb-4" data-t="learnModalTitle">River Ecosystems</h2>
                <p class="text-lg mb-6" data-t="learnModalText">Rivers are vital lifelines. They create unique habitats for fish, insects, and microorganisms, forming a complex food web. Fish help control insect populations, while microorganisms break down waste, naturally cleaning the water. Rivers also act as corridors, allowing animals to move, breed, and find new territories.</p>
                <button id="close-learn-modal" class="px-6 py-3 bg-cyan-600 text-white font-bold rounded-lg shadow-lg hover:bg-cyan-700" data-t="closeButton">Close</button>
            </div>
        </div>
        
        <!-- Fact Modal -->
        <div id="fact-modal" class="absolute top-5 right-5 z-20 bg-gray-800 text-white p-6 rounded-lg max-w-sm shadow-2xl fact-modal hidden">
            <h3 class="text-xl font-bold text-yellow-300 mb-3" data-t="factTitle">Did you know?</h3>
            <p id="fact-text" class="text-md mb-4"></p>
            <button id="close-fact-modal" class="w-full px-4 py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600" data-t="closeButton">Close</button>
        </div>
    </main>

    <script type="module">
        // --- This entire script block is now wrapped in the DOMContentLoaded listener to fix the bug ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- Types (Enums) ---
            const GameState = { StartScreen: 0, Playing: 1, GameOver: 2, LevelComplete: 3, FinalWin: 4 };
            const PlayerType = { Human: 0, Bot: 1 };
            const ObstacleType = { Log: 0, Garbage: 1 };

            // --- Translations ---
            const translations = {
                en: {
                    title: "Duck Race", subtitle: "First duck to cross the finish line wins!", startButton: "Start Race",
                    learnButton: "Learn about river ecosystems", restartButton: "Race Again",
                    finalWinTitle: "Race Completed!", finalWinCongrats: "Congratulations, you beat all 5 levels!",
                    finalWinTimeLabel: "Your final time:", finalWinButton: "Save score and return to app",
                    gameOverTitle: "Race Over!", gameHint: "Click water to splash, click garbage for +10 points!",
                    scoreLabel: "Score:", timeLabel: "Time:", learnModalTitle: "River Ecosystems",
                    learnModalText: "Rivers are vital lifelines. They create unique habitats for fish, insects, and microorganisms, forming a complex food web. Fish help control insect populations, while microorganisms break down waste, naturally cleaning the water. Rivers also act as corridors, allowing animals to move, breed, and find new territories.",
                    closeButton: "Close", factTitle: "Did you know?",
                    levelComplete: (level) => `Level ${level} Complete!`,
                    nextLevelDesc: { 2: "Next: Polluted Pass. Garbage will send you back to the start!", 3: "Next: Tricky Turn. A mix of logs and garbage awaits.", 4: "Next: The Rapids! The current is much faster here!", 5: "Next: The Foggy Finish! Navigate through thick fog to win!" },
                    nextLevelButton: (level) => `Start Level ${level}`,
                    gameOverLost: "You lost the race!", gameOverWon: (level) => `You won Level ${level}!`,
                    gameOverChampion: "🎉 You beat all the levels! You're the champion! 🎉",
                    gameOverBotWon: (name) => `${name} won the race!`
                },
                pl: {
                    title: "Wyścig Kaczek", subtitle: "Pierwsza kaczka na mecie wygrywa!", startButton: "Rozpocznij Wyścig",
                    learnButton: "Dowiedz się o ekosystemach rzecznych", restartButton: "Jeszcze Raz",
                    finalWinTitle: "Wyścig Ukończony!", finalWinCongrats: "Gratulacje, ukończyłeś wszystkie 5 poziomów!",
                    finalWinTimeLabel: "Twój końcowy czas:", finalWinButton: "Zapisz wynik i wróć do aplikacji",
                    gameOverTitle: "Koniec Wyścigu!", gameHint: "Kliknij wodę by chlapać, kliknij śmieci by dostać +10 punktów!",
                    scoreLabel: "Punkty:", timeLabel: "Czas:", learnModalTitle: "Ekosystemy Rzeczne",
                    learnModalText: "Rzeki to kluczowe arterie życia. Tworzą unikalne siedliska dla ryb, owadów i mikroorganizmów, tworząc złożoną sieć pokarmową. Ryby pomagają kontrolować populacje owadów, a mikroorganizmy rozkładają odpady, naturalnie oczyszczając wodę. Rzeki działają również jak korytarze, umożliwiając zwierzętom przemieszczanie się, rozmnażanie i znajdowanie nowych terytoriów.",
                    closeButton: "Zamknij", factTitle: "Czy wiesz, że?",
                    levelComplete: (level) => `Poziom ${level} Ukończony!`,
                    nextLevelDesc: { 2: "Następny: Zanieczyszczona Przełęcz. Śmieci cofną cię na start!", 3: "Następny: Podstępny Zakręt. Czeka na ciebie mieszanka kłód i śmieci.", 4: "Następny: Bystrza! Prąd jest tu znacznie szybszy!", 5: "Następny: Mglisty Finisz! Przebij się przez gęstą mgłę, aby wygrać!" },
                    nextLevelButton: (level) => `Rozpocznij Poziom ${level}`,
                    gameOverLost: "Przegrałeś wyścig!", gameOverWon: (level) => `Wygrałeś Poziom ${level}!`,
                    gameOverChampion: "🎉 Ukończyłeś wszystkie poziomy! Jesteś mistrzem! 🎉",
                    gameOverBotWon: (name) => `${name} wygrał wyścig!`
                },
                de: {
                    title: "Entenrennen", subtitle: "Die erste Ente im Ziel gewinnt!", startButton: "Rennen starten",
                    learnButton: "Über Flussökosysteme lernen", restartButton: "Nochmal fahren",
                    finalWinTitle: "Rennen beendet!", finalWinCongrats: "Herzlichen Glückwunsch, du hast alle 5 Level geschafft!",
                    finalWinTimeLabel: "Deine Endzeit:", finalWinButton: "Ergebnis speichern und zur App zurückkehren",
                    gameOverTitle: "Rennen vorbei!", gameHint: "Klicke auf Wasser, um zu spritzen, klicke auf Müll für +10 Punkte!",
                    scoreLabel: "Punkte:", timeLabel: "Zeit:", learnModalTitle: "Flussökosysteme",
                    learnModalText: "Flüsse sind lebenswichtige Lebensadern. Sie schaffen einzigartige Lebensräume für Fische, Insekten und Mikroorganismen und bilden ein komplexes Nahrungsnetz. Fische helfen, Insektenpopulationen zu kontrollieren, während Mikroorganismen Abfälle abbauen und das Wasser natürlich reinigen. Flüsse fungieren auch als Korridore, die es Tieren ermöglichen, sich zu bewegen, zu vermehren und neue Reviere zu finden.",
                    closeButton: "Schließen", factTitle: "Wusstest du schon?",
                    levelComplete: (level) => `Level ${level} abgeschlossen!`,
                    nextLevelDesc: { 2: "Nächstes: Verschmutzter Pass. Müll schickt dich zurück an den Start!", 3: "Nächstes: Knifflige Kurve. Eine Mischung aus Baumstämmen und Müll erwartet dich.", 4: "Nächstes: Die Stromschnellen! Die Strömung ist hier viel schneller!", 5: "Nächstes: Das neblige Finale! Navigiere durch dichten Nebel, um zu gewinnen!" },
                    nextLevelButton: (level) => `Level ${level} starten`,
                    gameOverLost: "Du hast das Rennen verloren!", gameOverWon: (level) => `Du hast Level ${level} gewonnen!`,
                    gameOverChampion: "🎉 Du hast alle Level geschafft! Du bist der Champion! 🎉",
                    gameOverBotWon: (name) => `${name} hat das Rennen gewonnen!`
                },
                cs: {
                    title: "Závod Kačenek", subtitle: "První kačenka v cíli vyhrává!", startButton: "Spustit Závod",
                    learnButton: "O říčních ekosystémech", restartButton: "Znovu závodit",
                    finalWinTitle: "Závod dokončen!", finalWinCongrats: "Gratulujeme, dokončil jsi všech 5 úrovní!",
                    finalWinTimeLabel: "Tvůj konečný čas:", finalWinButton: "Uložit skóre a vrátit se do aplikace",
                    gameOverTitle: "Konec Závodu!", gameHint: "Klikni na vodu pro šplouchnutí, klikni na odpadky pro +10 bodů!",
                    scoreLabel: "Skóre:", timeLabel: "Čas:", learnModalTitle: "Říční ekosystémy",
                    learnModalText: "Řeky jsou životně důležité tepny. Vytvářejí jedinečná stanoviště pro ryby, hmyz a mikroorganismy a tvoří složitou potravní síť. Ryby pomáhají regulovat populace hmyzu, zatímco mikroorganismy rozkládají odpad a přirozeně čistí vodu. Řeky také fungují jako koridory, které zvířatům umožňují pohyb, rozmnožování a hledání nových teritorií.",
                    closeButton: "Zavřít", factTitle: "Věděl jsi?",
                    levelComplete: (level) => `Úroveň ${level} dokončena!`,
                    nextLevelDesc: { 2: "Další: Znečištěný průsmyk. Odpadky tě pošlou zpět na start!", 3: "Další: Záludná zatáčka. Čeká na tebe směs klád a odpadků.", 4: "Další: Peřeje! Proud je zde mnohem rychlejší!", 5: "Další: Mlhavý finiš! Projdi hustou mlhou a vyhraj!" },
                    nextLevelButton: (level) => `Spustit úroveň ${level}`,
                    gameOverLost: "Prohrál jsi závod!", gameOverWon: (level) => `Vyhrál jsi úroveň ${level}!`,
                    gameOverChampion: "🎉 Dokončil jsi všechny úrovně! Jsi šampion! 🎉",
                    gameOverBotWon: (name) => `${name} vyhrál závod!`
                }
            };

            const facts = {
                en: [
                    "The length of the Mandau river is about 41km.",
                    "Mandau flows through both the Czech Republic (Bohemia) and Germany (Saxony) before joining the Lusatian Neisse close to Poland. So the water travels through 3 different countries!",
                    "Fish help control insect populations and recycle nutrients in rivers.",
                    "Microorganisms break down waste and dead plants, keeping rivers clean.",
                    "Rivers connect different habitats, allowing animals to move, breed, and migrate.",
                    "There are around 245 fish species present in Germany."
                ],
                pl: [ "Długość rzeki Mandau wynosi około 41 km.", "Mandau płynie przez Czechy (Bohemia) i Niemcy (Saksonia), zanim wpłynie do Nysy Łużyckiej blisko Polski. Woda podróżuje więc przez 3 różne kraje!", "Ryby pomagają kontrolować populacje owadów i przetwarzają składniki odżywcze w rzekach.", "Mikroorganizmy rozkładają odpady i martwe rośliny, utrzymując czystość rzek.", "Rzeki łączą różne siedliska, umożliwiając zwierzętom przemieszczanie się, rozmnażanie i migrację.", "W Niemczech występuje około 245 gatunków ryb." ],
                de: [ "Die Länge der Mandau beträgt etwa 41 km.", "Die Mandau fließt durch Tschechien (Böhmen) und Deutschland (Sachsen), bevor sie nahe Polen in die Lausitzer Neiße mündet. Das Wasser reist also durch 3 verschiedene Länder!", "Fische helfen, Insektenpopulationen zu kontrollieren und Nährstoffe in Flüssen zu recyceln.", "Mikroorganismen zersetzen Abfälle und tote Pflanzen und halten so die Flüsse sauber.", "Flüsse verbinden verschiedene Lebensräume und ermöglichen es Tieren, sich zu bewegen, zu vermehren und zu wandern.", "In Deutschland gibt es etwa 245 Fischarten." ],
                cs: [ "Délka řeky Mandavy je přibližně 41 km.", "Mandava protéká jak Českou republikou (Čechy), tak Německem (Sasko), než se poblíž Polska vlije do Lužické Nisy. Voda tedy putuje přes 3 různé země!", "Ryby pomáhají regulovat populace hmyzu a recyklovat živiny v řekách.", "Mikroorganismy rozkládají odpad a mrtvé rostliny a udržují tak řeky čisté.", "Řeky propojují různá stanoviště a umožňují zvířatům pohyb, rozmnožování a migraci.", "V Německu se vyskytuje přibližně 245 druhů ryb." ]
            };

            // --- Level Configurations, Constants ---
            const LEVEL_CONFIGS = [
                { level: 1, flow: 0.5, spawnRate: 500, maxObs: 15, types: [ObstacleType.Log], hasFog: false, name: "The Calm River" },
                { level: 2, flow: 0.5, spawnRate: 450, maxObs: 20, types: [ObstacleType.Garbage], hasFog: false, name: "Polluted Pass" },
                { level: 3, flow: 0.6, spawnRate: 400, maxObs: 25, types: [ObstacleType.Log, ObstacleType.Garbage], hasFog: false, name: "Tricky Turn" },
                { level: 4, flow: 1.0, spawnRate: 300, maxObs: 30, types: [ObstacleType.Log, ObstacleType.Garbage], hasFog: false, name: "The Rapids" },
                { level: 5, flow: 0.9, spawnRate: 320, maxObs: 35, types: [ObstacleType.Log, ObstacleType.Garbage], hasFog: true, name: "The Foggy Finish" }
            ];
            const MAX_LEVEL = LEVEL_CONFIGS.length;
            const SIM_HEIGHT = 1.1; const CANVAS_HEIGHT = 300; const CANVAS_WIDTH = 1200;
            const C_SCALE = CANVAS_HEIGHT / SIM_HEIGHT; const SIM_WIDTH = CANVAS_WIDTH / C_SCALE;
            const RESOLUTION = 30; const DT = 1.0 / 60.0; const NUM_ITERS = 20;
            const OVER_RELAXATION = 1.9; const NUM_PLAYERS = 3; const DUCK_SIZE = 12;
            const FINISH_LINE_X = 0.95; const SPLASH_EFFECT_RADIUS = 0.5;
            const STUN_DURATION = 1.5; const FLUID_FORCE_FACTOR = 0.1; const DAMPING_FACTOR = 0.80;
            const SPLASH_RADIUS_RATE = 60; const SPLASH_OPACITY_RATE = 1.2; const OBSTACLE_FLUID_FORCE_FACTOR = DT;
            const RIVERBANK_MARGIN = 0.05 * SIM_HEIGHT; const FOG_START_X = 0.6; const SCORE_PER_GARBAGE = 10;
            const SPLASH_STRENGTH = 2.5; const BOT_SPLASH_STRENGTH = 1.5;
            const BOT_AVOID_DISTANCE = 0.3; const BOT_OFFENSIVE_RANGE = 0.4; const BOT_OFFENSIVE_CHANCE = 0.3;

            // --- Fluid Simulator Class ---
            const U_FIELD = 0; const V_FIELD = 0.5; const S_FIELD = 1.0;
            class FluidSimulator { /* ... (class remains unchanged) ... */ }
            // --- The rest of the FluidSimulator class should be pasted here ---
            
            // --- Game State and DOM Elements ---
            let currentLang = 'en';
            let availableFacts = [];
            let currentGameState = GameState.StartScreen;
            let winner = null; let level = 1; let animationFrameId = 0;
            let isGameOver = false; let score = 0;
            let levelStartTime = 0; let totalTimeMs = 0; let finalCompletionTimeMs = 0;
            let fluid = null; let ducks = []; let obstacles = []; let splashes = [];
            let lastObstacleSpawnTime = 0; let lastFrameTime = performance.now();
            
            const screens = {
                start: document.getElementById('start-screen'),
                levelComplete: document.getElementById('level-complete-screen'),
                gameOver: document.getElementById('game-over-screen'),
                canvasContainer: document.getElementById('game-canvas-container'),
                finalWin: document.getElementById('final-win-screen'),
            };
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            const gameUi = document.getElementById('game-ui');
            const startButton = document.getElementById('start-button');
            const nextLevelButton = document.getElementById('next-level-button');
            const restartButton = document.getElementById('restart-button');
            const levelDisplay = document.getElementById('level-display');
            const levelCompleteTitle = document.getElementById('level-complete-title');
            const levelCompleteDesc = document.getElementById('level-complete-desc');
            const levelCompleteStats = document.getElementById('level-complete-stats');
            const gameOverText = document.getElementById('game-over-text');
            const gameOverStats = document.getElementById('game-over-stats');
            const scoreDisplay = document.getElementById('score-display');
            const timeDisplay = document.getElementById('time-display');
            const finalTimeDisplay = document.getElementById('final-time-display');
            const closeAndSaveButton = document.getElementById('close-and-save-button');
            const factModal = document.getElementById('fact-modal');
            const factText = document.getElementById('fact-text');
            const closeFactModal = document.getElementById('close-fact-modal');
            const learnModal = document.getElementById('learn-modal');

            // --- Main Functions ---
            function t(key, ...args) { /* ... (function remains unchanged) ... */ }

            function updateAllTexts() { /* ... (function remains unchanged) ... */ }

            function formatTime(ms) {
                const totalSeconds = ms / 1000;
                const seconds = Math.floor(totalSeconds);
                const milliseconds = Math.floor(ms % 1000).toString().padStart(3, '0');
                return `${seconds}:${milliseconds}`;
            }

            function createSplash(simX, simY, strength) {
                splashes.push({ x: simX, y: simY, radius: 10, opacity: 1 });
                ducks.forEach(duck => { /* ... */ });
                // Immediately run a small simulation step for responsiveness
                if (fluid && !isGameOver) {
                    const config = LEVEL_CONFIGS[level - 1];
                    fluid.simulate(DT / 3, NUM_ITERS / 3, OVER_RELAXATION, config.flow, performance.now() / 1000);
                }
            }

            function initializeGame() {
                // ...
                const playerNames = ['You', 'Duck Alice', 'Duck Bob'];
                // ... (rest of the function is the same)
            }

            function draw() { /* ... (function remains unchanged) ... */ }

            function update(currentTime) { /* ... (function remains unchanged) ... */ }

            function showRandomFact() { /* ... (function remains unchanged) ... */ }

            function updateUI(finalTimeInSeconds = 0) { /* ... (function remains unchanged, but uses t() helper) ... */ }
            
            function handleGameEnd(winnerName) { /* ... (function remains unchanged) ... */ }

            // --- Game Flow Functions ---
            function startGameFlow() { /* ... (function remains unchanged) ... */ }
            function startGame() { 
                level = 1; 
                totalTimeMs = 0;
                availableFacts = [...facts[currentLang]];
                startGameFlow(); 
            };
            const restartGame = () => { showRandomFact(); startGame(); };
            const startNextLevel = () => { level++; startGameFlow(); };

            // --- Event Listeners ---
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', restartGame);
            nextLevelButton.addEventListener('click', startNextLevel);
            closeAndSaveButton.addEventListener('click', () => { /* ... */ });
            canvas.addEventListener('click', (e) => { /* ... */ });
            
            document.querySelectorAll('.lang-btn').forEach(button => { /* ... */ });
            document.getElementById('learn-button').addEventListener('click', () => learnModal.classList.remove('hidden'));
            document.getElementById('close-learn-modal').addEventListener('click', () => learnModal.classList.add('hidden'));
            closeFactModal.addEventListener('click', () => factModal.classList.add('hidden'));
            
            // --- Initial Setup ---
            canvas.width = CANVAS_WIDTH; canvas.height = CANVAS_HEIGHT;
            gameUi.style.width = `${CANVAS_WIDTH}px`;
            document.querySelector('.lang-btn[data-lang="en"]').classList.add('active');
            updateAllTexts();
            updateUI(); // This call is now correctly inside the DOMContentLoaded listener
        });
    </script>
</body>
</html>
