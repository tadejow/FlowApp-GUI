<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Duck Race - Pure HTML</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            background-color: #111827;
        }
        .hidden { display: none; }
        
        /* NEW: Styles inspired by Reynolds Experiment */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); }
            100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
        }
        .welcome-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid #374151;
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
        }
        .btn { transition: all 0.2s ease; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { animation: pulse 2s infinite; }
        .btn-primary:hover { transform: translateY(-3px) scale(1.05); }
        .btn-secondary:hover { background-color: #374151; border-color: #facc15; }
        .lang-btn.active { background-color: #facc15; color: #111827; border-color: #fde047; }
        .fact-modal { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="text-white">
    <main class="relative w-screen h-screen flex items-center justify-center bg-cover bg-center" style="background-image: url('../assets/duck-background.jpg')">
        <div id="main-overlay" class="absolute inset-0 bg-blue-900 bg-opacity-40 backdrop-blur-sm"></div>

        <!-- NEW: Redesigned Start Screen -->
        <div id="start-screen" class="relative z-10 text-center p-4">
             <div class="welcome-panel p-8 md:p-12 rounded-xl shadow-2xl max-w-xl w-full">
                <h1 class="text-4xl md:text-5xl font-bold text-yellow-300 mb-2" data-t="title">Duck Race</h1>
                <p class="text-lg text-cyan-200 mb-8" data-t="subtitle">First duck to cross the finish line wins!</p>
                <div class="flex flex-col items-center gap-4">
                    <button id="start-button" class="btn btn-primary w-full md:w-auto px-8 py-3 bg-yellow-400 text-gray-900 font-bold rounded-lg shadow-lg" data-t="startButton">
                        Start Race
                    </button>
                    <button id="learn-button" class="btn btn-secondary w-full md:w-auto px-6 py-3 bg-gray-700/50 border border-gray-600 text-yellow-300 font-bold rounded-lg" data-t="learnButton">
                        Learn about river ecosystems
                    </button>
                    <div id="lang-switcher" class="mt-4 p-2 bg-black bg-opacity-50 rounded-lg flex gap-2">
                        <button class="lang-btn px-4 py-1 rounded" data-lang="en">EN</button>
                        <button class="lang-btn px-4 py-1 rounded" data-lang="pl">PL</button>
                        <button class="lang-btn px-4 py-1 rounded" data-lang="de">DE</button>
                        <button class="lang-btn px-4 py-1 rounded" data-lang="cs">CS</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Level Complete Screen -->
        <div id="level-complete-screen" class="relative z-10 text-center bg-black bg-opacity-70 p-10 rounded-xl hidden">
            <h2 id="level-complete-title" class="text-5xl font-bold text-yellow-300 mb-4"></h2>
            <p id="level-complete-stats" class="text-xl text-cyan-200 mb-6"></p>
            <p id="level-complete-desc" class="text-2xl text-white mb-6"></p>
            <button id="next-level-button" class="px-8 py-4 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600"></button>
        </div>
        
        <!-- Final Win Screen -->
        <div id="final-win-screen" class="relative z-10 text-center bg-black bg-opacity-70 p-10 rounded-xl hidden">
            <h2 class="text-5xl font-bold text-yellow-300 mb-4" data-t="finalWinTitle">Race Completed!</h2>
            <p class="text-2xl text-white mb-2" data-t="finalWinCongrats">Congratulations, you beat all 5 levels!</p>
            <p class="text-xl text-cyan-200 mb-8" data-t="finalWinTimeLabel">Your final time:</p>
            <p id="final-time-display" class="text-4xl font-mono text-yellow-300 mb-8"></p>
            <button id="close-and-save-button" class="px-8 py-4 bg-blue-500 text-white font-bold rounded-lg shadow-lg hover:bg-blue-600" data-t="finalWinButton">
                Save score and return to app
            </button>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="relative z-10 text-center bg-black bg-opacity-70 p-10 rounded-xl hidden">
            <h2 class="text-5xl font-bold text-yellow-300 mb-4" data-t="gameOverTitle">Race Over!</h2>
            <p id="game-over-text" class="text-3xl text-white mb-6"></p>
            <p id="game-over-stats" class="text-xl text-cyan-200 mb-6"></p>
            <button id="restart-button" class="px-8 py-4 bg-yellow-400 text-gray-900 font-bold rounded-lg shadow-lg hover:bg-yellow-500" data-t="restartButton">
                Race Again
            </button>
        </div>

        <!-- Game Canvas Area -->
        <div id="game-canvas-container" class="relative z-10 flex flex-col items-center hidden">
            <div id="game-ui" class="text-white bg-black bg-opacity-50 px-4 py-2 rounded-t-lg flex justify-between items-center w-full">
                <div>
                    <h2 id="level-display" class="text-xl font-bold text-yellow-300"></h2>
                    <p class="text-sm text-cyan-100" data-t="gameHint">Click water to splash, click garbage for +10 points!</p>
                </div>
                 <div class="text-center mx-4">
                    <p class="text-lg font-bold" data-t="scoreLabel">Score: <span id="score-display" class="font-mono">0</span></p>
                    <p class="text-lg font-bold" data-t="timeLabel">Time: <span id="time-display" class="font-mono">00:00</span></p>
                </div>
                <div class="w-48"></div>
            </div>
            <canvas id="game-canvas" class="bg-blue-800 bg-opacity-80 border-4 border-yellow-400 rounded-b-lg shadow-2xl"></canvas>
        </div>

        <!-- Learn Modal -->
        <div id="learn-modal" class="absolute inset-0 z-20 bg-black bg-opacity-75 flex items-center justify-center hidden p-4">
            <div class="bg-gray-800 text-white p-8 rounded-lg max-w-2xl text-center shadow-2xl">
                <h2 class="text-3xl font-bold text-cyan-300 mb-4" data-t="learnModalTitle">River Ecosystems</h2>
                <p class="text-lg mb-6" data-t="learnModalText">Rivers are vital lifelines. They create unique habitats for fish, insects, and microorganisms, forming a complex food web. Fish help control insect populations, while microorganisms break down waste, naturally cleaning the water. Rivers also act as corridors, allowing animals to move, breed, and find new territories.</p>
                <button id="close-learn-modal" class="px-6 py-3 bg-cyan-600 text-white font-bold rounded-lg shadow-lg hover:bg-cyan-700" data-t="closeButton">Close</button>
            </div>
        </div>
        
        <!-- Fact Modal -->
        <div id="fact-modal" class="absolute top-5 right-5 z-20 bg-gray-800 text-white p-6 rounded-lg max-w-sm shadow-2xl fact-modal hidden">
            <h3 class="text-xl font-bold text-yellow-300 mb-3" data-t="factTitle">Did you know?</h3>
            <p id="fact-text" class="text-md mb-4"></p>
            <button id="close-fact-modal" class="w-full px-4 py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600" data-t="closeButton">Close</button>
        </div>
    </main>

    <script type="module">
        // --- This entire script block is now wrapped in the DOMContentLoaded listener to fix the bug ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- Types (Enums) ---
            const GameState = { StartScreen: 0, Playing: 1, GameOver: 2, LevelComplete: 3, FinalWin: 4 };
            const PlayerType = { Human: 0, Bot: 1 };
            const ObstacleType = { Log: 0, Garbage: 1 };

            // --- Translations ---
            const translations = {
                en: {
                    title: "Duck Race", subtitle: "First duck to cross the finish line wins!", startButton: "Start Race",
                    learnButton: "Learn about river ecosystems", restartButton: "Race Again",
                    finalWinTitle: "Race Completed!", finalWinCongrats: "Congratulations, you beat all 5 levels!",
                    finalWinTimeLabel: "Your final time:", finalWinButton: "Save score and return to app",
                    gameOverTitle: "Race Over!", gameHint: "Click water to splash, click garbage for +10 points!",
                    scoreLabel: "Score:", timeLabel: "Time:", learnModalTitle: "River Ecosystems",
                    learnModalText: "Rivers are vital lifelines. They create unique habitats for fish, insects, and microorganisms, forming a complex food web. Fish help control insect populations, while microorganisms break down waste, naturally cleaning the water. Rivers also act as corridors, allowing animals to move, breed, and find new territories.",
                    closeButton: "Close", factTitle: "Did you know?",
                    levelComplete: (level) => `Level ${level} Complete!`,
                    nextLevelDesc: { 2: "Next: Polluted Pass. Garbage will send you back to the start!", 3: "Next: Tricky Turn. A mix of logs and garbage awaits.", 4: "Next: The Rapids! The current is much faster here!", 5: "Next: The Foggy Finish! Navigate through thick fog to win!" },
                    nextLevelButton: (level) => `Start Level ${level}`,
                    gameOverLost: "You lost the race!", gameOverWon: (level) => `You won Level ${level}!`,
                    gameOverChampion: "ðŸŽ‰ You beat all the levels! You're the champion! ðŸŽ‰",
                    gameOverBotWon: (name) => `${name} won the race!`
                },
                pl: {
                    title: "WyÅ›cig Kaczek", subtitle: "Pierwsza kaczka na mecie wygrywa!", startButton: "Rozpocznij WyÅ›cig",
                    learnButton: "Dowiedz siÄ™ o ekosystemach rzecznych", restartButton: "Jeszcze Raz",
                    finalWinTitle: "WyÅ›cig UkoÅ„czony!", finalWinCongrats: "Gratulacje, ukoÅ„czyÅ‚eÅ› wszystkie 5 poziomÃ³w!",
                    finalWinTimeLabel: "TwÃ³j koÅ„cowy czas:", finalWinButton: "Zapisz wynik i wrÃ³Ä‡ do aplikacji",
                    gameOverTitle: "Koniec WyÅ›cigu!", gameHint: "Kliknij wodÄ™ by chlapaÄ‡, kliknij Å›mieci by dostaÄ‡ +10 punktÃ³w!",
                    scoreLabel: "Punkty:", timeLabel: "Czas:", learnModalTitle: "Ekosystemy Rzeczne",
                    learnModalText: "Rzeki to kluczowe arterie Å¼ycia. TworzÄ… unikalne siedliska dla ryb, owadÃ³w i mikroorganizmÃ³w, tworzÄ…c zÅ‚oÅ¼onÄ… sieÄ‡ pokarmowÄ…. Ryby pomagajÄ… kontrolowaÄ‡ populacje owadÃ³w, a mikroorganizmy rozkÅ‚adajÄ… odpady, naturalnie oczyszczajÄ…c wodÄ™. Rzeki dziaÅ‚ajÄ… rÃ³wnieÅ¼ jak korytarze, umoÅ¼liwiajÄ…c zwierzÄ™tom przemieszczanie siÄ™, rozmnaÅ¼anie i znajdowanie nowych terytoriÃ³w.",
                    closeButton: "Zamknij", factTitle: "Czy wiesz, Å¼e?",
                    levelComplete: (level) => `Poziom ${level} UkoÅ„czony!`,
                    nextLevelDesc: { 2: "NastÄ™pny: Zanieczyszczona PrzeÅ‚Ä™cz. Åšmieci cofnÄ… ciÄ™ na start!", 3: "NastÄ™pny: PodstÄ™pny ZakrÄ™t. Czeka na ciebie mieszanka kÅ‚Ã³d i Å›mieci.", 4: "NastÄ™pny: Bystrza! PrÄ…d jest tu znacznie szybszy!", 5: "NastÄ™pny: Mglisty Finisz! Przebij siÄ™ przez gÄ™stÄ… mgÅ‚Ä™, aby wygraÄ‡!" },
                    nextLevelButton: (level) => `Rozpocznij Poziom ${level}`,
                    gameOverLost: "PrzegraÅ‚eÅ› wyÅ›cig!", gameOverWon: (level) => `WygraÅ‚eÅ› Poziom ${level}!`,
                    gameOverChampion: "ðŸŽ‰ UkoÅ„czyÅ‚eÅ› wszystkie poziomy! JesteÅ› mistrzem! ðŸŽ‰",
                    gameOverBotWon: (name) => `${name} wygraÅ‚ wyÅ›cig!`
                },
                de: {
                    title: "Entenrennen", subtitle: "Die erste Ente im Ziel gewinnt!", startButton: "Rennen starten",
                    learnButton: "Ãœber FlussÃ¶kosysteme lernen", restartButton: "Nochmal fahren",
                    finalWinTitle: "Rennen beendet!", finalWinCongrats: "Herzlichen GlÃ¼ckwunsch, du hast alle 5 Level geschafft!",
                    finalWinTimeLabel: "Deine Endzeit:", finalWinButton: "Ergebnis speichern und zur App zurÃ¼ckkehren",
                    gameOverTitle: "Rennen vorbei!", gameHint: "Klicke auf Wasser, um zu spritzen, klicke auf MÃ¼ll fÃ¼r +10 Punkte!",
                    scoreLabel: "Punkte:", timeLabel: "Zeit:", learnModalTitle: "FlussÃ¶kosysteme",
                    learnModalText: "FlÃ¼sse sind lebenswichtige Lebensadern. Sie schaffen einzigartige LebensrÃ¤ume fÃ¼r Fische, Insekten und Mikroorganismen und bilden ein komplexes Nahrungsnetz. Fische helfen, Insektenpopulationen zu kontrollieren, wÃ¤hrend Mikroorganismen AbfÃ¤lle abbauen und das Wasser natÃ¼rlich reinigen. FlÃ¼sse fungieren auch als Korridore, die es Tieren ermÃ¶glichen, sich zu bewegen, zu vermehren und neue Reviere zu finden.",
                    closeButton: "SchlieÃŸen", factTitle: "Wusstest du schon?",
                    levelComplete: (level) => `Level ${level} abgeschlossen!`,
                    nextLevelDesc: { 2: "NÃ¤chstes: Verschmutzter Pass. MÃ¼ll schickt dich zurÃ¼ck an den Start!", 3: "NÃ¤chstes: Knifflige Kurve. Eine Mischung aus BaumstÃ¤mmen und MÃ¼ll erwartet dich.", 4: "NÃ¤chstes: Die Stromschnellen! Die StrÃ¶mung ist hier viel schneller!", 5: "NÃ¤chstes: Das neblige Finale! Navigiere durch dichten Nebel, um zu gewinnen!" },
                    nextLevelButton: (level) => `Level ${level} starten`,
                    gameOverLost: "Du hast das Rennen verloren!", gameOverWon: (level) => `Du hast Level ${level} gewonnen!`,
                    gameOverChampion: "ðŸŽ‰ Du hast alle Level geschafft! Du bist der Champion! ðŸŽ‰",
                    gameOverBotWon: (name) => `${name} hat das Rennen gewonnen!`
                },
                cs: {
                    title: "ZÃ¡vod KaÄenek", subtitle: "PrvnÃ­ kaÄenka v cÃ­li vyhrÃ¡vÃ¡!", startButton: "Spustit ZÃ¡vod",
                    learnButton: "O Å™Ã­ÄnÃ­ch ekosystÃ©mech", restartButton: "Znovu zÃ¡vodit",
                    finalWinTitle: "ZÃ¡vod dokonÄen!", finalWinCongrats: "Gratulujeme, dokonÄil jsi vÅ¡ech 5 ÃºrovnÃ­!",
                    finalWinTimeLabel: "TvÅ¯j koneÄnÃ½ Äas:", finalWinButton: "UloÅ¾it skÃ³re a vrÃ¡tit se do aplikace",
                    gameOverTitle: "Konec ZÃ¡vodu!", gameHint: "Klikni na vodu pro Å¡plouchnutÃ­, klikni na odpadky pro +10 bodÅ¯!",
                    scoreLabel: "SkÃ³re:", timeLabel: "ÄŒas:", learnModalTitle: "Å˜Ã­ÄnÃ­ ekosystÃ©my",
                    learnModalText: "Å˜eky jsou Å¾ivotnÄ› dÅ¯leÅ¾itÃ© tepny. VytvÃ¡Å™ejÃ­ jedineÄnÃ¡ stanoviÅ¡tÄ› pro ryby, hmyz a mikroorganismy a tvoÅ™Ã­ sloÅ¾itou potravnÃ­ sÃ­Å¥. Ryby pomÃ¡hajÃ­ regulovat populace hmyzu, zatÃ­mco mikroorganismy rozklÃ¡dajÃ­ odpad a pÅ™irozenÄ› ÄistÃ­ vodu. Å˜eky takÃ© fungujÃ­ jako koridory, kterÃ© zvÃ­Å™atÅ¯m umoÅ¾ÅˆujÃ­ pohyb, rozmnoÅ¾ovÃ¡nÃ­ a hledÃ¡nÃ­ novÃ½ch teritoriÃ­.",
                    closeButton: "ZavÅ™Ã­t", factTitle: "VÄ›dÄ›l jsi?",
                    levelComplete: (level) => `ÃšroveÅˆ ${level} dokonÄena!`,
                    nextLevelDesc: { 2: "DalÅ¡Ã­: ZneÄiÅ¡tÄ›nÃ½ prÅ¯smyk. Odpadky tÄ› poÅ¡lou zpÄ›t na start!", 3: "DalÅ¡Ã­: ZÃ¡ludnÃ¡ zatÃ¡Äka. ÄŒekÃ¡ na tebe smÄ›s klÃ¡d a odpadkÅ¯.", 4: "DalÅ¡Ã­: PeÅ™eje! Proud je zde mnohem rychlejÅ¡Ã­!", 5: "DalÅ¡Ã­: MlhavÃ½ finiÅ¡! Projdi hustou mlhou a vyhraj!" },
                    nextLevelButton: (level) => `Spustit ÃºroveÅˆ ${level}`,
                    gameOverLost: "ProhrÃ¡l jsi zÃ¡vod!", gameOverWon: (level) => `VyhrÃ¡l jsi ÃºroveÅˆ ${level}!`,
                    gameOverChampion: "ðŸŽ‰ DokonÄil jsi vÅ¡echny ÃºrovnÄ›! Jsi Å¡ampion! ðŸŽ‰",
                    gameOverBotWon: (name) => `${name} vyhrÃ¡l zÃ¡vod!`
                }
            };

            const facts = {
                en: [
                    "The length of the Mandau river is about 41km.",
                    "Mandau flows through both the Czech Republic (Bohemia) and Germany (Saxony) before joining the Lusatian Neisse close to Poland. So the water travels through 3 different countries!",
                    "Fish help control insect populations and recycle nutrients in rivers.",
                    "Microorganisms break down waste and dead plants, keeping rivers clean.",
                    "Rivers connect different habitats, allowing animals to move, breed, and migrate.",
                    "There are around 245 fish species present in Germany."
                ],
                pl: [ "DÅ‚ugoÅ›Ä‡ rzeki Mandau wynosi okoÅ‚o 41 km.", "Mandau pÅ‚ynie przez Czechy (Bohemia) i Niemcy (Saksonia), zanim wpÅ‚ynie do Nysy ÅuÅ¼yckiej blisko Polski. Woda podrÃ³Å¼uje wiÄ™c przez 3 rÃ³Å¼ne kraje!", "Ryby pomagajÄ… kontrolowaÄ‡ populacje owadÃ³w i przetwarzajÄ… skÅ‚adniki odÅ¼ywcze w rzekach.", "Mikroorganizmy rozkÅ‚adajÄ… odpady i martwe roÅ›liny, utrzymujÄ…c czystoÅ›Ä‡ rzek.", "Rzeki Å‚Ä…czÄ… rÃ³Å¼ne siedliska, umoÅ¼liwiajÄ…c zwierzÄ™tom przemieszczanie siÄ™, rozmnaÅ¼anie i migracjÄ™.", "W Niemczech wystÄ™puje okoÅ‚o 245 gatunkÃ³w ryb." ],
                de: [ "Die LÃ¤nge der Mandau betrÃ¤gt etwa 41 km.", "Die Mandau flieÃŸt durch Tschechien (BÃ¶hmen) und Deutschland (Sachsen), bevor sie nahe Polen in die Lausitzer NeiÃŸe mÃ¼ndet. Das Wasser reist also durch 3 verschiedene LÃ¤nder!", "Fische helfen, Insektenpopulationen zu kontrollieren und NÃ¤hrstoffe in FlÃ¼ssen zu recyceln.", "Mikroorganismen zersetzen AbfÃ¤lle und tote Pflanzen und halten so die FlÃ¼sse sauber.", "FlÃ¼sse verbinden verschiedene LebensrÃ¤ume und ermÃ¶glichen es Tieren, sich zu bewegen, zu vermehren und zu wandern.", "In Deutschland gibt es etwa 245 Fischarten." ],
                cs: [ "DÃ©lka Å™eky Mandavy je pÅ™ibliÅ¾nÄ› 41 km.", "Mandava protÃ©kÃ¡ jak ÄŒeskou republikou (ÄŒechy), tak NÄ›meckem (Sasko), neÅ¾ se poblÃ­Å¾ Polska vlije do LuÅ¾ickÃ© Nisy. Voda tedy putuje pÅ™es 3 rÅ¯znÃ© zemÄ›!", "Ryby pomÃ¡hajÃ­ regulovat populace hmyzu a recyklovat Å¾iviny v Å™ekÃ¡ch.", "Mikroorganismy rozklÃ¡dajÃ­ odpad a mrtvÃ© rostliny a udrÅ¾ujÃ­ tak Å™eky ÄistÃ©.", "Å˜eky propojujÃ­ rÅ¯znÃ¡ stanoviÅ¡tÄ› a umoÅ¾ÅˆujÃ­ zvÃ­Å™atÅ¯m pohyb, rozmnoÅ¾ovÃ¡nÃ­ a migraci.", "V NÄ›mecku se vyskytuje pÅ™ibliÅ¾nÄ› 245 druhÅ¯ ryb." ]
            };

            // --- Level Configurations, Constants ---
            const LEVEL_CONFIGS = [
                { level: 1, flow: 0.5, spawnRate: 500, maxObs: 15, types: [ObstacleType.Log], hasFog: false, name: "The Calm River" },
                { level: 2, flow: 0.5, spawnRate: 450, maxObs: 20, types: [ObstacleType.Garbage], hasFog: false, name: "Polluted Pass" },
                { level: 3, flow: 0.6, spawnRate: 400, maxObs: 25, types: [ObstacleType.Log, ObstacleType.Garbage], hasFog: false, name: "Tricky Turn" },
                { level: 4, flow: 1.0, spawnRate: 300, maxObs: 30, types: [ObstacleType.Log, ObstacleType.Garbage], hasFog: false, name: "The Rapids" },
                { level: 5, flow: 0.9, spawnRate: 320, maxObs: 35, types: [ObstacleType.Log, ObstacleType.Garbage], hasFog: true, name: "The Foggy Finish" }
            ];
            const MAX_LEVEL = LEVEL_CONFIGS.length;
            const SIM_HEIGHT = 1.1; const CANVAS_HEIGHT = 300; const CANVAS_WIDTH = 1200;
            const C_SCALE = CANVAS_HEIGHT / SIM_HEIGHT; const SIM_WIDTH = CANVAS_WIDTH / C_SCALE;
            const RESOLUTION = 30; const DT = 1.0 / 60.0; const NUM_ITERS = 20;
            const OVER_RELAXATION = 1.9; const NUM_PLAYERS = 3; const DUCK_SIZE = 12;
            const FINISH_LINE_X = 0.95; const SPLASH_EFFECT_RADIUS = 0.5;
            const STUN_DURATION = 1.5; const FLUID_FORCE_FACTOR = 0.1; const DAMPING_FACTOR = 0.80;
            const SPLASH_RADIUS_RATE = 60; const SPLASH_OPACITY_RATE = 1.2; const OBSTACLE_FLUID_FORCE_FACTOR = DT;
            const RIVERBANK_MARGIN = 0.05 * SIM_HEIGHT; const FOG_START_X = 0.6; const SCORE_PER_GARBAGE = 10;
            const SPLASH_STRENGTH = 2.5; const BOT_SPLASH_STRENGTH = 1.5;
            const BOT_AVOID_DISTANCE = 0.3; const BOT_OFFENSIVE_RANGE = 0.4; const BOT_OFFENSIVE_CHANCE = 0.3;

            // --- Fluid Simulator Class ---
            const U_FIELD = 0; const V_FIELD = 0.5; const S_FIELD = 1.0;
            class FluidSimulator { /* ... (class remains unchanged) ... */ }
            // --- The rest of the FluidSimulator class should be pasted here ---
            
            // --- Game State and DOM Elements ---
            let currentLang = 'en';
            let availableFacts = [];
            let currentGameState = GameState.StartScreen;
            let winner = null; let level = 1; let animationFrameId = 0;
            let isGameOver = false; let score = 0;
            let levelStartTime = 0; let totalTimeMs = 0; let finalCompletionTimeMs = 0;
            let fluid = null; let ducks = []; let obstacles = []; let splashes = [];
            let lastObstacleSpawnTime = 0; let lastFrameTime = performance.now();
            
            const screens = {
                start: document.getElementById('start-screen'),
                levelComplete: document.getElementById('level-complete-screen'),
                gameOver: document.getElementById('game-over-screen'),
                canvasContainer: document.getElementById('game-canvas-container'),
                finalWin: document.getElementById('final-win-screen'),
            };
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            const gameUi = document.getElementById('game-ui');
            const startButton = document.getElementById('start-button');
            const nextLevelButton = document.getElementById('next-level-button');
            const restartButton = document.getElementById('restart-button');
            const levelDisplay = document.getElementById('level-display');
            const levelCompleteTitle = document.getElementById('level-complete-title');
            const levelCompleteDesc = document.getElementById('level-complete-desc');
            const levelCompleteStats = document.getElementById('level-complete-stats');
            const gameOverText = document.getElementById('game-over-text');
            const gameOverStats = document.getElementById('game-over-stats');
            const scoreDisplay = document.getElementById('score-display');
            const timeDisplay = document.getElementById('time-display');
            const finalTimeDisplay = document.getElementById('final-time-display');
            const closeAndSaveButton = document.getElementById('close-and-save-button');
            const factModal = document.getElementById('fact-modal');
            const factText = document.getElementById('fact-text');
            const closeFactModal = document.getElementById('close-fact-modal');
            const learnModal = document.getElementById('learn-modal');

            // --- Main Functions ---
            function t(key, ...args) { /* ... (function remains unchanged) ... */ }

            function updateAllTexts() { /* ... (function remains unchanged) ... */ }

            function formatTime(ms) {
                const totalSeconds = ms / 1000;
                const seconds = Math.floor(totalSeconds);
                const milliseconds = Math.floor(ms % 1000).toString().padStart(3, '0');
                return `${seconds}:${milliseconds}`;
            }

            function createSplash(simX, simY, strength) {
                splashes.push({ x: simX, y: simY, radius: 10, opacity: 1 });
                ducks.forEach(duck => { /* ... */ });
                // Immediately run a small simulation step for responsiveness
                if (fluid && !isGameOver) {
                    const config = LEVEL_CONFIGS[level - 1];
                    fluid.simulate(DT / 3, NUM_ITERS / 3, OVER_RELAXATION, config.flow, performance.now() / 1000);
                }
            }

            function initializeGame() {
                // ...
                const playerNames = ['You', 'Duck Alice', 'Duck Bob'];
                // ... (rest of the function is the same)
            }

            function draw() { /* ... (function remains unchanged) ... */ }

            function update(currentTime) { /* ... (function remains unchanged) ... */ }

            function showRandomFact() { /* ... (function remains unchanged) ... */ }

            function updateUI(finalTimeInSeconds = 0) { /* ... (function remains unchanged, but uses t() helper) ... */ }
            
            function handleGameEnd(winnerName) { /* ... (function remains unchanged) ... */ }

            // --- Game Flow Functions ---
            function startGameFlow() { /* ... (function remains unchanged) ... */ }
            function startGame() { 
                level = 1; 
                totalTimeMs = 0;
                availableFacts = [...facts[currentLang]];
                startGameFlow(); 
            };
            const restartGame = () => { showRandomFact(); startGame(); };
            const startNextLevel = () => { level++; startGameFlow(); };

            // --- Event Listeners ---
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', restartGame);
            nextLevelButton.addEventListener('click', startNextLevel);
            closeAndSaveButton.addEventListener('click', () => { /* ... */ });
            canvas.addEventListener('click', (e) => { /* ... */ });
            
            document.querySelectorAll('.lang-btn').forEach(button => { /* ... */ });
            document.getElementById('learn-button').addEventListener('click', () => learnModal.classList.remove('hidden'));
            document.getElementById('close-learn-modal').addEventListener('click', () => learnModal.classList.add('hidden'));
            closeFactModal.addEventListener('click', () => factModal.classList.add('hidden'));
            
            // --- Initial Setup ---
            canvas.width = CANVAS_WIDTH; canvas.height = CANVAS_HEIGHT;
            gameUi.style.width = `${CANVAS_WIDTH}px`;
            document.querySelector('.lang-btn[data-lang="en"]').classList.add('active');
            updateAllTexts();
            updateUI(); // This call is now correctly inside the DOMContentLoaded listener
        });
    </script>
</body>
</html>
